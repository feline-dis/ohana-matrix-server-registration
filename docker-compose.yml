services:
  caddy:
    image: caddy:2-alpine
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
      - "8448:8448"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - registration-proxy
      - conduwuit
      - livekit
      - lk-jwt-service
    restart: unless-stopped

  conduwuit:
    image: ghcr.io/matrix-construct/tuwunel:latest
    volumes:
      - conduwuit_data:/var/lib/conduwuit
    environment:
      CONDUWUIT_SERVER_NAME: ohana-matrix.xyz
      CONDUWUIT_DATABASE_PATH: /var/lib/conduwuit
      CONDUWUIT_PORT: 6167
      CONDUWUIT_ADDRESS: 0.0.0.0
      CONDUWUIT_ALLOW_REGISTRATION: "true"
      CONDUWUIT_REGISTRATION_TOKEN: ${INVITE_CODE}
      CONDUWUIT_ALLOW_FEDERATION: "true"
      CONDUWUIT_TRUSTED_SERVERS: '["matrix.org"]'
      CONDUWUIT_MAX_REQUEST_SIZE: "20000000"
      CONDUWUIT_CONFIG: ""
    restart: unless-stopped

  registration-proxy:
    build: .
    environment:
      - INVITE_CODE=${INVITE_CODE}
      - HOMESERVER_URL=http://conduwuit:6167
    depends_on:
      - conduwuit
    restart: unless-stopped

  livekit:
    image: livekit/livekit-server:latest
    command: --config /etc/livekit.yaml
    environment:
      - "LIVEKIT_KEYS=${LIVEKIT_KEY}: ${LIVEKIT_SECRET}"
    ports:
      - "7881:7881/tcp"
      - "50000-50200:50000-50200/udp"
    volumes:
      - ./livekit/livekit.yaml:/etc/livekit.yaml:ro
    restart: unless-stopped

  lk-jwt-service:
    image: ghcr.io/element-hq/lk-jwt-service:latest
    environment:
      - LIVEKIT_URL=wss://ohana-matrix.xyz/sfu
      - LIVEKIT_KEY=${LIVEKIT_KEY}
      - LIVEKIT_SECRET=${LIVEKIT_SECRET}
      - LK_JWT_PORT=8080
      - LIVEKIT_FULL_ACCESS_HOMESERVERS=ohana-matrix.xyz
    depends_on:
      - livekit
    restart: unless-stopped

volumes:
  caddy_data:
  caddy_config:
  conduwuit_data:

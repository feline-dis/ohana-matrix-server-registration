ohana-matrix.xyz {
	log {
		output stderr
	}

	handle /.well-known/matrix/client {
		header Content-Type application/json
		header Access-Control-Allow-Origin *
		respond `{"m.homeserver":{"base_url":"https://ohana-matrix.xyz"},"org.matrix.msc4143.rtc_foci":[{"type":"livekit","livekit_service_url":"https://ohana-matrix.xyz/livekit/jwt"}]}`
	}

	handle /.well-known/matrix/server {
		header Content-Type application/json
		respond `{"m.server":"ohana-matrix.xyz:8448"}`
	}

	handle_path /livekit/jwt* {
		reverse_proxy lk-jwt-service:8080
	}

	handle_path /livekit/sfu* {
		reverse_proxy livekit:7880
	}

	# Backward compat: old call memberships have livekit_service_url
	# set to https://ohana-matrix.xyz/sfu/get, and the client appends
	# /sfu/get to that, resulting in /sfu/get/sfu/get. Strip the base
	# so lk-jwt-service receives /sfu/get as expected.
	handle_path /sfu/get* {
		reverse_proxy lk-jwt-service:8080
	}

	handle {
		reverse_proxy registration-proxy:8008
	}
}

chat.ohana-matrix.xyz {
	reverse_proxy element-web:80
}

ohana-matrix.xyz:8448 {
	reverse_proxy conduwuit:6167
}
